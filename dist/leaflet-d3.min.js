/*! @asymmetrik/leaflet-d3 - 2.0.3 - Copyright (c) 2007-2017 Asymmetrik Ltd, a Maryland Corporation */
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("d3"),require("d3-hexbin"),require("leaflet")):"function"==typeof define&&define.amd?define(["exports","d3","d3-hexbin","leaflet"],i):i(t.leafletD3=t.leafletD3||{},t.d3,t.d3.hexbin)}(this,function(t,i,n){"use strict";var e=null!=i.hexbin?i.hexbin:null!=n?n.hexbin:null;L.HexbinLayer=(L.Layer?L.Layer:L.Class).extend({includes:[L.Mixin.Events],options:{radius:12,opacity:.6,duration:200,colorScaleExtent:[1,void 0],radiusScaleExtent:[1,void 0],colorRange:["#f7fbff","#08306b"],radiusRange:[4,12],pointerEvents:"all"},initialize:function(t){L.setOptions(this,t),this._fn={lng:function(t){return t[0]},lat:function(t){return t[1]},colorValue:function(t){return t.length},radiusValue:function(t){return Number.MAX_VALUE},fill:function(t){var i=this._fn.colorValue(t);return null!=i?this._scale.color(i):"none"}},this._scale={color:i.scaleLinear(),radius:i.scaleLinear()},this._dispatch=i.dispatch("mouseover","mouseout","click"),this._hexLayout=e().radius(this.options.radius).x(function(t){return t.point[0]}).y(function(t){return t.point[1]}),this._data=[],this._scale.color.range(this.options.colorRange).clamp(!0),this._scale.radius.range(this.options.radiusRange).clamp(!0)},onAdd:function(t){this._map=t,this._initContainer(),t.on({moveend:this.redraw},this),this.redraw()},onRemove:function(t){this._destroyContainer(),t.off({moveend:this.redraw},this),this._container=null,this._map=null},_initContainer:function(){if(null==this._container){var t=this._map.getPanes().overlayPane;this._container=i.select(t).append("svg").attr("class","leaflet-layer leaflet-zoom-hide")}},_destroyContainer:function(){null!=this._container&&this._container.remove()},redraw:function(){var t=this;if(t._map){var i=t._data.map(function(i){var n=t._fn.lng(i),e=t._fn.lat(i),o=t._project([n,e]);return{o:i,point:o}}),n=512,e=this._getBounds(i),o=e.max[0]-e.min[0]+2*n,a=e.max[1]-e.min[1]+2*n,s=e.min[1]-n,r=e.min[0]-n;this._container.attr("width",o).attr("height",a).style("margin-left",r+"px").style("margin-top",s+"px");var h=this._container.selectAll("g.hexbin").data([this._map.getZoom()],function(t){return t}),l=h.enter().append("g").attr("class",function(t){return"hexbin zoom-"+t}),u=l.merge(h);u.attr("transform","translate("+-r+","+-s+")"),h.exit().remove(),this._createHexagons(u,i)}},_createHexagons:function(t,i){var n=this,e=n._hexLayout(i),o=n._getExtent(e,n._fn.colorValue,n.options.colorScaleExtent),a=n._getExtent(e,n._fn.radiusValue,n.options.radiusScaleExtent),s=n._linearlySpace(o[0],o[1],n._scale.color.range().length);n._scale.color.domain(s),n._scale.radius.domain(a);var r=t.selectAll("path.hexbin-hexagon").data(e,function(t){return t.x+":"+t.y});r.transition().duration(n.options.duration).attr("fill",n._fn.fill.bind(n)).attr("fill-opacity",n.options.opacity).attr("stroke-opacity",n.options.opacity).attr("d",function(t){return n._hexLayout.hexagon(n._scale.radius(n._fn.radiusValue.call(n,t)))}),r.enter().append("path").attr("class","hexbin-hexagon").style("pointer-events",n.options.pointerEvents).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).attr("d",function(t){return n._hexLayout.hexagon(0)}).attr("fill",n._fn.fill.bind(n)).attr("fill-opacity",.01).attr("stroke-opacity",.01).on("mouseover",function(t,i){n._dispatch.call("mouseover",this,t,i)}).on("mouseout",function(t,i){n._dispatch.call("mouseout",this,t,i)}).on("click",function(t,i){n._dispatch.call("click",this,t,i)}).transition().duration(n.options.duration).attr("fill-opacity",n.options.opacity).attr("stroke-opacity",n.options.opacity).attr("d",function(t){return n._hexLayout.hexagon(n._scale.radius(n._fn.radiusValue.call(n,t)))}),r.exit().transition().duration(n.options.duration).attr("fill-opacity",.01).attr("stroke-opacity",.01).attr("d",function(t){return n._hexLayout.hexagon(0)}).remove()},_getExtent:function(t,n,e){var o=i.extent(t,n.bind(this));return null==o[0]&&(o[0]=0),null==o[1]&&(o[1]=0),null!=e[0]&&(o[0]=e[0]),null!=e[1]&&(o[1]=e[1]),o},_project:function(t){var i=this._map.latLngToLayerPoint([t[1],t[0]]);return[i.x,i.y]},_getBounds:function(t){if(null==t||t.length<1)return{min:[0,0],max:[0,0]};var i=[[999,999],[-999,-999]];return t.forEach(function(t){var n=t.point[0],e=t.point[1];i[0][0]=Math.min(i[0][0],n),i[0][1]=Math.min(i[0][1],e),i[1][0]=Math.max(i[1][0],n),i[1][1]=Math.max(i[1][1],e)}),{min:i[0],max:i[1]}},_linearlySpace:function(t,i,n){for(var e=new Array(n),o=(i-t)/Math.max(n-1,1),a=0;a<n;++a)e[a]=t+a*o;return e},radius:function(t){return arguments.length?(this.options.radius=t,this._hexLayout.radius(t),this):this.options.radius},opacity:function(t){return arguments.length?(this.options.opacity=t,this):this.options.opacity},duration:function(t){return arguments.length?(this.options.duration=t,this):this.options.duration},colorScaleExtent:function(t){return arguments.length?(this.options.colorScaleExtent=t,this):this.options.colorScaleExtent},radiusScaleExtent:function(t){return arguments.length?(this.options.radiusScaleExtent=t,this):this.options.radiusScaleExtent},colorRange:function(t){return arguments.length?(this.options.colorRange=t,this._scale.color.range(t),this):this.options.colorRange},radiusRange:function(t){return arguments.length?(this.options.radiusRange=t,this._scale.radius.range(t),this):this.options.radiusRange},colorScale:function(t){return arguments.length?(this._scale.color=t,this):this._scale.color},radiusScale:function(t){return arguments.length?(this._scale.radius=t,this):this._scale.radius},lng:function(t){return arguments.length?(this._fn.lng=t,this):this._fn.lng},lat:function(t){return arguments.length?(this._fn.lat=t,this):this._fn.lat},colorValue:function(t){return arguments.length?(this._fn.colorValue=t,this):this._fn.colorValue},radiusValue:function(t){return arguments.length?(this._fn.radiusValue=t,this):this._fn.radiusValue},fill:function(t){return arguments.length?(this._fn.fill=t,this):this._fn.fill},data:function(t){return arguments.length?(this._data=null!=t?t:[],this.redraw(),this):this._data},dispatch:function(){return this._dispatch},getLatLngs:function(){var t=this;return this._data.map(function(i){return L.latLng(t.options.lat(i),t.options.lng(i))})},toGeoJSON:function(){return L.GeoJSON.getFeature(this,{type:"LineString",coordinates:L.GeoJSON.latLngsToCoords(this.getLatLngs(),0)})}}),L.hexbinLayer=function(t){return new L.HexbinLayer(t)},L.PingLayer=(L.Layer?L.Layer:L.Class).extend({includes:[L.Mixin.Events],options:{duration:800,fps:32,opacityRange:[1,0],radiusRange:[3,15]},initialize:function(t){L.setOptions(this,t),this._fn={lng:function(t){return t[0]},lat:function(t){return t[1]},radiusScaleFactor:function(t){return 1}},this._scale={radius:i.scalePow().exponent(.35),opacity:i.scaleLinear()},this._lastUpdate=Date.now(),this._fps=0,this._mapBounds=void 0,this._scale.radius.domain([0,this.options.duration]).range(this.options.radiusRange).clamp(!0),this._scale.opacity.domain([0,this.options.duration]).range(this.options.opacityRange).clamp(!0)},onAdd:function(t){this._map=t,this._running=!1,this._initContainer(),this._updateContainer(),t.on({move:this._move},this)},onRemove:function(t){this._destroyContainer(),t.off({move:this._move},this),this._container=null,this._map=null,this._data=null},_initContainer:function(){if(null==this._container){var t=this._map.getPanes().overlayPane;this._container=i.select(t).append("svg").attr("class","leaflet-layer leaflet-zoom-hide")}},_updateContainer:function(){var t=this._getMapBounds();this._mapBounds=t,this._container.attr("width",t.width).attr("height",t.height).style("margin-left",t.left+"px").style("margin-top",t.top+"px"),this._update(!0)},_destroyContainer:function(){null!=this._container&&this._container.remove()},_getMapBounds:function(){var t=this._map.getBounds(),i=this._map.latLngToLayerPoint(t.getNorthEast()),n=this._map.latLngToLayerPoint(t.getSouthWest()),e={width:i.x-n.x,height:n.y-i.y,left:n.x,top:i.y};return e},_getCircleCoords:function(t){var i=this._map.latLngToLayerPoint(t);return{x:i.x-this._mapBounds.left,y:i.y-this._mapBounds.top}},_move:function(){this._updateContainer()},_add:function(t,i){null==this._data&&(this._data=[]);var n=[this._fn.lat(t),this._fn.lng(t)],e=this._getCircleCoords(n),o={data:t,geo:n,ts:Date.now(),nts:0};o.c=this._container.append("circle").attr("class",null!=i?"ping "+i:"ping").attr("cx",e.x).attr("cy",e.y).attr("r",this._fn.radiusScaleFactor.call(this,t)*this._scale.radius.range()[0]),this._data.push(o)},_update:function(t){var i=Date.now();null==this._data&&(this._data=[]);for(var n=-1,e=0;e<this._data.length;e++){var o=this._data[e],a=i-o.ts;if(this.options.duration<a)o.c.remove(),n=e;else if(t||o.nts<i){var s=this._getCircleCoords(o.geo);o.c.attr("cx",s.x).attr("cy",s.y).attr("r",this._fn.radiusScaleFactor.call(this,o.data)*this._scale.radius(a)).attr("fill-opacity",this._scale.opacity(a)).attr("stroke-opacity",this._scale.opacity(a)),o.nts=Math.round(i+1e3/this.options.fps)}}return n>-1&&this._data.splice(0,n+1),this._running=this._data.length>0,this._running&&(this._fps=1e3/(i-this._lastUpdate),this._lastUpdate=i),!this._running},_expire:function(){for(var t=-1,i=Date.now(),n=0;n<this._data.length;n++){var e=this._data[n],o=i-e.ts;if(!(this.options.duration<o))break;e.c.remove(),t=n}t>-1&&this._data.splice(0,t+1)},duration:function(t){return arguments.length?(this.options.duration=t,this):this.options.duration},fps:function(t){return arguments.length?(this.options.fps=t,this):this.options.fps},lng:function(t){return arguments.length?(this._fn.lng=t,this):this._fn.lng},lat:function(t){return arguments.length?(this._fn.lat=t,this):this._fn.lat},radiusRange:function(t){return arguments.length?(this.options.radiusRange=t,this._scale.radius().range(t),this):this.options.radiusRange},opacityRange:function(t){return arguments.length?(this.options.opacityRange=t,this._scale.opacity().range(t),this):this.options.opacityRange},radiusScale:function(t){return arguments.length?(this._scale.radius=t,this):this._scale.radius},opacityScale:function(t){return arguments.length?(this._scale.opacity=t,this):this._scale.opacity},radiusScaleFactor:function(t){return arguments.length?(this._fn.radiusScaleFactor=t,this):this._fn.radiusScaleFactor},ping:function(t,n){if(this._add(t,n),this._expire(),!this._running&&this._data.length>0){this._running=!0,this._lastUpdate=Date.now();var e=this;i.timer(function(){e._update.call(e,!1)})}return this},getActualFps:function(){return this._fps},data:function(){return this._data}}),L.pingLayer=function(t){return new L.PingLayer(t)},/**
 * Initial work by Teralytics AG (Copyright 2015)
 * @author Kirill Zhuravlev <kirill.zhuravlev@teralytics.ch>
 *
 */
L.version>="1.0"&&i.select("head").append("style").attr("type","text/css").text("g.d3-overlay *{pointer-events:visiblePainted;}"),L.D3SvgLayer=(L.Layer?L.Layer:L.Class).extend({includes:L.version<"1.0"?L.Mixin.Events:[],_undef:function(t){return"undefined"==typeof t},_options:function(t){return this._undef(t)?this.options:(t.zoomHide=!this._undef(t.zoomHide)&&t.zoomHide,t.zoomDraw=!!this._undef(t.zoomDraw)||t.zoomDraw,this.options=t)},_disableLeafletRounding:function(){this._leaflet_round=L.Point.prototype._round,L.Point.prototype._round=function(){return this}},_enableLeafletRounding:function(){L.Point.prototype._round=this._leaflet_round},draw:function(){this._disableLeafletRounding(),this._drawCallback(this.selection,this.projection,this.map.getZoom()),this._enableLeafletRounding()},initialize:function(t,i){this._options(i||{}),this._drawCallback=t},_zoomChange:function(t){this._disableLeafletRounding();var i=this._undef(t.zoom)?this.map._zoom:t.zoom;this._zoomDiff=i-this._zoom,this._scale=Math.pow(2,this._zoomDiff),this.projection.scale=this._scale,this._shift=this.map.latLngToLayerPoint(this._wgsOrigin)._subtract(this._wgsInitialShift.multiplyBy(this._scale));var n=["translate(",this._shift.x,",",this._shift.y,") "],e=["scale(",this._scale,",",this._scale,") "];this._rootGroup.attr("transform",n.concat(e).join("")),this.options.zoomDraw&&this.draw(),this._enableLeafletRounding()},onAdd:function(t){this.map=t;var n=this;L.version<"1.0"?(t._initPathRoot(),this._svg=i.select(t._panes.overlayPane).select("svg"),this._rootGroup=this._svg.append("g")):(this._svg=L.svg(),t.addLayer(this._svg),this._rootGroup=i.select(this._svg._rootGroup).classed("d3-overlay",!0)),this._rootGroup.classed("leaflet-zoom-hide",this.options.zoomHide),this.selection=this._rootGroup,this.initHelperValues(),this.projection={latLngToLayerPoint:function(t,i){i=n._undef(i)?n._zoom:i;var e=n.map.project(L.latLng(t),i)._round();return e._subtract(n._pixelOrigin)},layerPointToLatLng:function(t,i){i=n._undef(i)?n._zoom:i;var e=L.point(t).add(n._pixelOrigin);return n.map.unproject(e,i)},unitsPerMeter:256*Math.pow(2,n._zoom)/40075017,map:n.map,layer:n,scale:1},this.projection._projectPoint=function(t,i){var e=n.projection.latLngToLayerPoint(new L.LatLng(i,t));this.stream.point(e.x,e.y)},i.geo?this.projection.pathFromGeojson=i.geo.path().projection(i.geo.transform({point:this.projection._projectPoint})):this.projection.pathFromGeojson=i.geoPath().projection(i.geoTransform({point:this.projection._projectPoint})),this.projection.latLngToLayerFloatPoint=this.projection.latLngToLayerPoint,this.projection.getZoom=this.map.getZoom.bind(this.map),this.projection.getBounds=this.map.getBounds.bind(this.map),this.selection=this._rootGroup,L.version<"1.0"&&t.on("viewreset",this._zoomChange,this),this.draw()},getEvents:function(){return{zoomend:this._zoomChange}},onRemove:function(t){L.version<"1.0"?(t.off("viewreset",this._zoomChange,this),this._rootGroup.remove()):this._svg.remove()},addTo:function(t){return t.addLayer(this),this},initHelperValues:function(){this._pixelOrigin=this.map.getPixelOrigin(),this._wgsOrigin=L.latLng([0,0]),this._wgsInitialShift=this.map.latLngToLayerPoint(this._wgsOrigin),this._zoom=this.map.getZoom(),this._shift=L.point(0,0),this._scale=1}}),L.D3SvgLayer.version="3.0",L.d3SvgLayer=function(t,i){return new L.D3SvgLayer(t,i)},Object.defineProperty(t,"__esModule",{value:!0})});